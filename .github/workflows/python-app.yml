name: FastAPI-Deployment-Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. AWS 자격 증명 설정
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # (삭제됨) S3 업로드 단계: FastAPI는 코드가 이미지 안에 포함되므로 S3 동기화가 불필요합니다.
      # 만약 .env 파일 같은 설정 파일만 따로 관리하고 싶다면 그 부분만 남길 수 있습니다.

      # 3. ECR 로그인
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4. Docker 이미지 빌드 및 푸시
      - name: Build and push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Dockerfile이 프로젝트 루트에 있어야 합니다.
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # 5. SSM을 통한 EC2 배포 (FastAPI 맞춤 설정)
      - name: Deploy to EC2 via SSM
        run: |
          REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          REPO="${{ secrets.ECR_REPOSITORY }}"
          TAG="${{ github.sha }}"
          FULL_IMAGE="$REGISTRY/$REPO:$TAG"

          # 문법 주의: --targets 뒤에 줄바꿈 문자(\)가 있어야 합니다.
          aws ssm send-command \
            --targets "Key=tag:${{ secrets.ASG_TAG_KEY }},Values=${{ secrets.ASG_TAG_VALUE}}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploying FastAPI via GitHub Actions" \
            --region ${{ secrets.AWS_REGION }} \
            --parameters "{
              \"commands\": [
                \"# EC2 내부: Docker 로그인\",
                \"aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | sudo docker login --username AWS --password-stdin $REGISTRY\",
                
                \"# EC2 내부: 최신 이미지 Pull\",
                \"sudo docker pull $FULL_IMAGE\",
                
                \"# EC2 내부: 기존 컨테이너 중지 및 삭제 (이름: fastapi-server)\",
                \"sudo docker stop fastapi-server-2 || true\",
                \"sudo docker rm fastapi-server-2 || true\",
                
                \"# EC2 내부: FastAPI 컨테이너 실행\",
                \"# -p 80:8000 -> EC2(80) 포트를 컨테이너(8000) 포트로 연결\",
                \"# -e 옵션으로 필요한 환경 변수를 주입할 수 있습니다.\",
                \"sudo docker run -d --name fastapi-server-2 -p 8000:8002 \
                  -e DB_HOST=${{ secrets.DB_HOST }} \
                  -e DB_USER=${{ secrets.DB_USER }} \
                  -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
                  $FULL_IMAGE\",
                
                \"# EC2 내부: 이미지 정리\",
                \"sudo docker image prune -f\"
              ]
            }"